---
title: "functions_final"
author: "Bertrand"
date: "10 décembre 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(elo)
library(purrr)
```


___________________________________________________________________
## Data import

Importing matches data from online git


Function import 
```{r}

import_central_matches <- function(i,central_matches = as.data.frame(c())){
  years_matches <- read.csv(file=paste("https://raw.githubusercontent.com/JeffSackmann/tennis_atp/master/atp_matches_",i,".csv",sep = ""))
  central_matches <- central_matches %>% bind_rows(years_matches)
  return(central_matches)
}

```


```{r}
import <- function() {
  timeline <- c(1968:as.numeric(substr(as.character(Sys.Date()),1,4)))
  central_matches <- map_df(timeline,import_central_matches) %>% 
    distinct() %>% 
    arrange(tourney_date, 
            match_num)
  central_matches %>% write.csv(file="atp_matches_combined.csv")
  
  return(central_matches)
}

central_matches <- import()

```

___________________________________________________________________
## Data tidying

Updates *central_matches* from online git and add new matches to *central_matches*

```{r}

 
tennis_update <- function(){
   
  df <- read.csv("atp_matches_combined.csv") %>% select(-X)
   
   update_date <- df %>% 
      select(tourney_date) %>% 
      distinct(tourney_date) %>% 
      top_n(1) %>% 
      as.character() %>% 
      as.Date(format = '%Y%m%d')
    
    tyear <- as.numeric(substr(as.character(Sys.Date()),1,4))
  
  
    last_matches <- read.csv(file=paste("https://raw.githubusercontent.com/JeffSackmann/tennis_atp/master/atp_matches_",tyear,".csv",sep = ""))
    
    last_matches <- last_matches %>% 
      select(tourney_date) %>% 
      distinct(tourney_date) %>% 
      top_n(1) %>% 
      as.character() %>% 
      as.Date(format = '%Y%m%d')
    
    update_year <- as.numeric(substr(as.character(update_date),1,4))

    
    if(update_date < last_matches){
        
      difference <- tyear-update_year
      years_missing <- c((tyear - (difference)):tyear)
      df <- union(df,map_df(years_missing,import_central_matches)) %>% distinct()
     
      df %>% write.csv(file="atp_matches_combined.csv")
    }
    else{NULL}
    
    
    
   return(as.data.frame(df) %>% distinct())
    
}


central_matches <- tennis_update()

```

Function to fill in the blanks in the dataset

```{r}
# There was Nones in the surface collumn for the Davis Cup 2017
data_fill <- function(central_matches) {
  central_matches <- central_matches %>%  
    mutate(surface = as.character(surface))
  central_matches <- central_matches %>% mutate(surface = case_when(surface == "None" ~ "Hard", 
                                TRUE ~ surface
                                ))
  return(central_matches)
}



central_matches <- data_fill(central_matches)

```


Transformation of the statistics transformation as percentage

```{r}
stat_transformation <- function(data) {
 data <-  data %>%
   mutate(w_1stin_n = w_1stIn/w_svpt, w_1stWon_n = w_1stWon/w_1stIn, w_2ndWon_n = w_2ndWon/(w_svpt-w_1stIn), w_bp_n = w_bpSaved/w_bpFaced) %>% 
   mutate(l_1stin_n = l_1stIn/l_svpt, l_1stWon_n = l_1stWon/l_1stIn, l_2ndWon_n = l_2ndWon/(l_svpt-l_1stIn), l_bp_n = l_bpSaved/l_bpFaced)
}

central_matches <- stat_transformation(central_matches)
```


Data cleaning (removing doublons)

```{r}

player_ID_table <-function(central_matches) {
  plopw <- central_matches %>% 
    select(winner_id,winner_name) %>% 
    group_by(winner_id) %>% 
    distinct() %>% 
    ungroup() %>% 
    rename("IDw" = "winner_id" ) %>% 
    rename("name" = "winner_name")

  plopl <- central_matches %>% 
    select(loser_id,loser_name) %>% 
    group_by(loser_id) %>% 
    distinct() %>% 
    ungroup() %>% 
    rename("IDl" = "loser_id" ) %>% 
    rename("name" = "loser_name")

  plop <- full_join(plopl, plopw, by = "name") %>% mutate(
    ID = case_when(is.na(IDw) == F ~ IDw,T ~ IDl)) %>% 
    select(-IDl,-IDw) 
}

plop <- player_ID_table(central_matches)
# plop <- plop %>% unique()

plop_doublons <- plop[duplicated(plop),]
plop_doublons_distinct <- plop[duplicated(plop),] %>%  distinct(name , .keep_all = T) 


central_matches_temp <- central_matches

central_matches_temp$winner_id <- unlist(lapply(central_matches_temp$winner_id, FUN = function(x) {
  if (x %in% plop_doublons$ID) {
    player_name <- plop_doublons[which(plop_doublons$ID == x),]$name
    plop_doublons_distinct[which(plop_doublons_distinct$name == player_name),]$ID
  }
  else x
}))

central_matches_temp$loser_id <- unlist(lapply(central_matches_temp$loser_id, FUN = function(x) {
  if (x %in% plop_doublons$ID) {
    player_name <- plop_doublons[which(plop_doublons$ID == x),]$name
    plop_doublons_distinct[which(plop_doublons_distinct$name == player_name),]$ID
  }
  else x
}))

plop <- plop %>% unique()

central_matches_temp <- central_matches_temp %>%  mutate(winner_id = case_when(
  winner_id == 111135 ~ 107140,
  winner_id == 111136 ~ 100065,
  winner_id == 109945 ~ 100076,
  winner_id == 101128 ~ 108831,
  T ~ as.numeric(winner_id)
)) %>% mutate(loser_id = case_when(
  loser_id == 111135 ~ 107140,
  loser_id == 111136 ~ 100065,
  loser_id == 109945 ~ 100076,
  loser_id == 101128 ~ 108831,
  T ~ as.numeric(loser_id)
))


### /!\ Ces 2 dataframe sont à mettre directement dans le package !

central_matches <- central_matches_temp

IDtbl <- player_ID_table(central_matches)
```

___________________________________________________________________
## Elo computation

Full elo calculation based on *central_matches* results

```{r}

elo_calculation <- function(central_matches) {

central_matches_temp <- central_matches
                # Name change to avoid modifying the global variable
  
central_matches_temp <- central_matches_temp %>% 
  mutate(tourney_id = as.character(tourney_id)) %>%
    mutate(
      score1 = 1, # Winners always score 1
      score0 = 0, # Loosers always score 0
      winner_id = as.character(winner_id),
      loser_id = as.character(loser_id)
      )

elo_run <- elo.run(formula =  score(score1 , score0) ~ winner_id + loser_id, data = central_matches_temp, k = 50)

elo_scores <- elo_run[["elos"]]
elo_players <- elo_run[["teams"]]

elo_scores <- as.data.frame(elo_scores)
colnames(elo_scores)[1:7] <- c("id1","id2","proba","winner","diffelo","elo1","elo2")
elo_scores$id1 <- lapply(elo_scores$id1,FUN = function(x){elo_players[[x]]}) #ID update from elo_players
elo_scores$id2 <- lapply(elo_scores$id2,FUN = function(x){elo_players[[x]]})
elo_scores <- elo_scores %>% select(-winner)

return(elo_scores)
}

```

Adding 4 collumns to central_matches : each player after match elo, the probability of player 1 winning and the elo modification caused by the match

```{r}

elo_central_matches <- function(central_matches) {
  central_matches_temp <- central_matches %>% drop_na(tourney_date,winner_id)
  elos <- elo_calculation(central_matches)
  try(central_matches_temp <- select(central_matches_temp,-proba,-diffelo,-elo1,-elo2), silent = TRUE)
  central_matches_temp <- cbind.data.frame(central_matches_temp,elos)
  central_matches_temp <- central_matches_temp %>% select(-c(id1,id2))
  return(central_matches_temp)
}

central_matches_test <- elo_central_matches(central_matches %>% filter(surface %in% c("Clay")))

```


___________________________________________________________________

## Functions to extract variables


1. Base functions :

Finding ID of player with his full name from match history 

```{r}
findID <- function(Name, data = IDtbl) {
  x <- IDtbl %>% filter(name == Name)
  x <- as.numeric(x$ID)
  return(x)
  remove(x)
}

findID("David Goffin", IDtbl)
```

Finding full name of player with his ID from *IDtbl* table

```{r}
ID_to_name <- function(id, data = IDtbl) {
  ID <- IDtbl %>% filter(ID == id) %>% 
    select(name)
  return(ID)
}

ID_to_name(105676, IDtbl)
```

2. History functions

Match history of a player from his ID with all collumns

```{r}

player_history_table_raw <- function(ID, data) {
  central_matches_temp <- data %>% 
    filter(winner_id == ID | loser_id == ID) %>% 
    mutate(status = case_when(winner_id == ID ~ "Win",T ~ "Loss"),
           opponent = case_when(winner_id == ID ~ loser_name,
                                T ~ winner_name),
           year = as.integer(substr(tourney_date, 1, 4)))
  return(central_matches_temp)
}

player_history_table_raw(103819, central_matches_test)
```


Match history of a player from his ID with only relevant collumns

```{r}
player_history_table <- function(ID, data) {
   tablehist <- player_history_table_raw(ID, data) %>%
   select(status,tourney_date,opponent,score,surface)
 return(tablehist)
}

player_history_table(103819, central_matches_test)
```

Matches history of several players from vector of IDs with all columns (histories of each player are binded by row)

```{r}
player_history_table_raw_multiple <- function(IDs, data) {
  n <- length(IDs)
  players_history <- map_dfr(IDs, player_history_table_raw, data = data, .id = "id")
  names <- map(as.character(IDs), ID_to_name)
  for (i in 1:length(players_history$id)) {
    players_history$id[i] <- as.character(names[[as.integer(players_history$id[i])]])
  }
  players_history <- players_history %>% 
    mutate(id = as.factor(id), 
           round = as.character(round))
 
  return(players_history)
}

player_history_table_raw_multiple(c(104745, 103819), central_matches_test)
```


Elo history of a player from ID : returns the ELO of the player at the end of each year from 1968 to 2018

```{r}
elo_history <- function(ID, data) {
  elo_history <- player_history_table_raw(ID, data) %>%
    group_by(year) %>% 
    slice(n()) %>% 
    summarise(elo = case_when(
        winner_id == ID ~ elo1,
        loser_id == ID ~ elo2))
  time_range <- data.frame(year = 1968:2018)

  return(full_join(time_range, elo_history %>% mutate(year = as.numeric(year)), by = "year"))  
}

elo_history(103819, data = central_matches_test)
```


ELOs history of several players from a vector of IDs with all columns : returns the ELO of each player at the end of each year from 1968 to 2018 (histories are binded by row)

```{r}
elo_history_multiple <- function(IDs, data) {
  players_elo_history <- map_dfr(IDs, elo_history, data = data, .id = "id")
  
  names <- map(as.character(IDs), ID_to_name)
  
  for (i in 1:length(players_elo_history$id)) {
    players_elo_history$id[i] <- as.character(names[[as.integer(players_elo_history$id[i])]])
  }
  players_elo_history <- players_elo_history %>% mutate(id = as.factor(id))
  return(players_elo_history)
}

elo_history_multiple(c(104745, 103819), central_matches_test)
```


3. Function to plot any statistic (example is mean number of double fault per match)

```{r}
stat_plot <- function(data, stat) {
  
  data <- na.omit(data) 
  
  total <- data %>% 
    group_by(year, id) %>% 
    summarise(total = n())
  
  a1 <- data %>%
    filter(status == "Loss") %>% 
    group_by(year, id) %>% 
    summarise_at(vars(matches(paste0("l_", stat))), sum)
  
 a2 <- data %>% filter(status == "Win") %>% 
      group_by(year, id) %>% 
      summarise_at(vars(matches(paste0("w_", stat))), sum)
 
  table <- inner_join(total, a1, by = c("year", "id")) %>% 
    inner_join(a2, by = c("year", "id"))
  names(table)[4:5] <- c("x1","x2")
  table %>% 
    group_by(year, id) %>% 
    mutate(mean_stats = (x1+x2)/total) %>% 
    ggplot(aes(x = year, y = mean_stats, colour = id)) +
    geom_line()
}

stat_plot(player_history_table_raw_multiple(c(104745, 103819), data = central_matches), "df")
```


4. Bet prediction

Function to return last elo for a player and given a dataframe with elo computed with wanted criterias

```{r}
elo_player <- function(ID, data) {
  data %>%
    filter(winner_id == ID | loser_id == ID) %>% 
    mutate(elo = case_when(
        winner_id == ID ~ elo1,
        loser_id == ID ~ elo2)) %>% 
    slice(n()) %>% 
    select(elo)
}

elo_player(103819, central_matches_test)
```


```{r}
prob_win <- function(ID1,ID2, data) {
  prob <- elo.prob(as.numeric(elo_player(ID1, data)),as.numeric(elo_player(ID2, data)))
  return(prob)
}

prob_win(103819, 104755, central_matches_test)
```


```{r}
odds_bet<- function(odd1,odd2,ID1,ID2, risk = 5, data){
  myprobwin1 <- prob_win(ID1,ID2, data)
  pwinbetter1 <- 1/odd1
  pwinbetter2 <- 1/odd2
  
  seuil <- 1/(risk*5)
  
  delta1 <- myprobwin1 - pwinbetter1
  delta2 <- 1-myprobwin1 - pwinbetter2
  
  if (pwinbetter1 + pwinbetter2 < 1) {
    recommandation <- glue::glue("that you check the betting odds again! If they are correct you can bet on both players in such ways so you will win money whatever happens : Bet at least {round(pwinbetter1,2)} of the amount on player 1,  and at least {round(pwinbetter2,2)} of the amount on player 2.")
  }
  
  else {
    
      if (delta1 >= seuil & delta2 <= seuil){
        recommandation <- glue::glue("betting on {ID_to_name(ID1)}")
      }
      else if (delta2 >= seuil & delta1 <= seuil){
        recommandation <- glue::glue("betting on {ID_to_name(ID2)}")
      }
      else if (delta1 <= seuil & delta2 <= seuil){
        recommandation <- "not betting"
      }
     
  }
  
  recommandation <- glue::glue("We would recommand {recommandation} !")
    
  return(list(myprobwin1, 1-myprobwin1, recommandation))
}


odds_bet(1.5, 3, 103819, 104755, risk = 5, data = central_matches_test)


```



